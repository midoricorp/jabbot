#!/usr/bin/make -f
#
# Sample debian/rules that uses javahelper.
# This file was generated by jh_makepkg and may be used
# without restriction. It was inspired by the dh-make
# sample debian/rules

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1


# Put depended upon jars in here
# export CLASSPATH=


version=`xpath -q -e "/project/version/text()" $(CURDIR)/pom.xml`

MVN = mvn -q -Dmaven.test.skip=true -Duser.home="$(HOME)" -s"$(HOME)/.m2/settings.xml"


build: build-arch-stamp build-indep-stamp
build-arch: build-arch-stamp
build-arch-stamp:
	dh_testdir
	touch $@

build-indep: build-indep-stamp
build-indep-stamp:
	dh_testdir

	# Build the package
	@$(MVN) install -Pstandalone
	mkdir $(CURDIR)/build
	tar -xvzf $(CURDIR)/jabbot-daemon/target/jabbot-daemon-$(version)-standalone.tar.gz -C $(CURDIR)/build/
	mv $(CURDIR)/build/jabbot-daemon-$(version) $(CURDIR)/build/jabbot-daemon
	chmod -x $(CURDIR)/build/jabbot-daemon/lib/*.jar

	touch $@

clean:
	dh_testdir
	dh_testroot

	find $(CURDIR)/extensions/ -name '*.tar.gz' -type f -exec bash -c 'rm -rf  "$(CURDIR)/debian/$$(basename {} .tar.gz)"' \;
	find $(CURDIR)/bindings/ -name '*.tar.gz' -type f -exec bash -c 'rm -rf  "$(CURDIR)/debian/$$(basename {} .tar.gz)"' \;

	rm -rf $(CURDIR)/build
	@$(MVN) clean

	dh_clean
	rm -f build-arch-stamp build-indep-stamp

install-indep: build-indep
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs

	find $(CURDIR)/extensions/ -name '*.tar.gz' -type f -exec bash -c 'mkdir -p "$(CURDIR)/debian/$$(basename {} .tar.gz)/var/lib/extensions"' \;
	find $(CURDIR)/extensions/ -name '*.tar.gz' -type f -exec bash -c 'tar -xvzf {} -C  "$(CURDIR)/debian/$$(basename {} .tar.gz)/var/lib/extensions"' \;
	find $(CURDIR)/bindings/ -name '*.tar.gz' -type f -exec bash -c 'mkdir -p "$(CURDIR)/debian/$$(basename {} .tar.gz)/var/lib/extensions"' \;
	find $(CURDIR)/bindings/ -name '*.tar.gz' -type f -exec bash -c 'tar -xvzf {} -C  "$(CURDIR)/debian/$$(basename {} .tar.gz)/var/lib/extensions"' \;

	
	#  mvn install


binary-arch: build-arch
	# Java packages are arch: all, nothing to do here

binary-indep: build-indep install-indep
	# Create the package here
	dh_testdir
	dh_testroot
	dh_installchangelogs
	dh_installdocs
	#jh_installjavadoc -i
	dh_installexamples
	dh_install
	dh_install jabbot-daemon/src/main/scripts/config.json etc/jabbot/jabbot-daemon/src/main/scripts/
	find extensions/ -name config.json -printf "dh_install %h/%f etc/jabbot/%h\n"|bash -C
	find bindings/ -name config.json -printf "dh_install %h/%f etc/jabbot/%h\n"|bash -C
	dh_installinit
	dh_installman
	dh_lintian
	#jh_manifest -i
	dh_link
	#jh_exec -i
	#jh_installlibs -i
	jh_depends -i -j headless
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb
	dh_auto_clean

	rm -rf $(CURDIR)/build
	rm -f build-arch-stamp build-indep-stamp

binary: binary-indep binary-arch
.PHONY: build build-arch build-indep clean binary-indep binary-arch binary install-indep
